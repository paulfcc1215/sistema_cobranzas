<?php

	phpinfo();
	die();

    require 'config.php';

	// DAYANARA pide cada mes
	$cuentas = array('2534193','2545453','2527641','2513507','2521474','2549392','2540890','2537684','2533477','2527170','100630','105083','2511986','2527280','2527654','2533745','2522552','2521653','2541011','105821','2539254','2539510','2540311','113302','2518207','2536304','2528057','2540935','2510868','2533265','2512051','2539637','103974','2527666','2515779','2521549','2511503','2527058','2548416','2548636','2526729','2548813','2539760','2522078','2548681','2510758','2506880','2539838','2515516','2533831','103952','2103640','2536668','2510234','2543730','105318','2547032','2548421','120139','2511773','2534597','2545160','2523320','2527539','2537901','2511635','2511684','2532879','2520849','2522394','2527428','2521769','2530047','110587','2529671','2529840','2524708','2548764','2536822','2507850','2528145','1000883','2534776','2529801','105756','2541053','2545570','2521100','2543761','110832','121104','2533504','2511816','2516488','2103379','2528197','2535460','2542370','2509930','2531492','2542591','2525966','107340','2533310','1000846','2522639','2544800','2541002','2529056','2549628','2548500','2527385','2532946','2545039','2533568','2548309','2514762','2517184','113207','2533210','2103560','113047','2537034','2545238','2535215','2546163','2523144','2547501','2543899','2536213','2515233','2529051','2514533','2515887','2544926','2517711','107715','2540196','2536450','1000364','2511898','2524262','2510147','113699','2546560','2546503','2532554','2548282','2519652','2531327','2104368','1000239','118215','2512012','2547289','2542230','2549147','2536327','2542100','102555','115240','2545715','2103857','2519142','119576','2549502','2545473','2545003','2512296','111736','2536047','2536110','2532914','2532895','2530769','2533752','2533540','2534828','2526468','2527691','100300','2520169','118178','2527018','108970','119637','109064','2515754','2535496','2522422','2510548','2549639','2548763','2536253','2513438','2544079','2532150','2523423','2512528','2539369','2548538','2536333','120406','110385','2540523','2522156','2539675','2515131','2532146','2543155','2527681','2547230','107220','111710','2533459','2527503','2537720','2515771','2540819','2531823','104499','2533600','2535715','2521014','107740','2523949','2532838','114695','114664','2505020','2520905','2545195','120403','2507413','2506807','2524530','2520159','108549','2514765','2524255','2515383','2549158','2542268','2516123','2527858','2511418','2549429','2515329','110199','2532302','2511061','2102965','2540295','2533088','2525446','2535544','2516223','2535371','2519889','100297','2537328','2535543','2533610','2534062','2548705','2537575','2519819','120693','2511193','2521537','2549379','2516359','2534911','2539016','105886','2534965','2524780','2515459','100009','109791','2520779','2547408','102975','111766','2524173','110172','2542532','2547552','118884','2542239','2542482','100896','105408','2537108','2518270','2507385','2535131','2549323','2533006','115007','2541699','2532594','2515143','102627','2520576','2520131','100112','2518101','2521790','2546552','2531624','106320','2534731','2512412','2530434','104247','2517189','2529629','114938','101522','119284','2546142','2522974','2529822','2523485','2521255','2512904','115999','2517700','2549847','102888','2533252','101281','2549784','2549801','105594','2103862','2531035','2542363','115248','1000005','2547441','105729','2531900','2529579','2535502','2531662','2527384','2533587','2508084','2541820','2535440','2521698','103372','2519768','110617','2504563','2520085','2514741','105840','2547308','2528329','2521927','2542094','2537885','2507074','101707','116156','2520886','2101598','2507353','2546882','2519865','2523699','109769','2509757','2531046','2527101','111812','2542252','2516804','2543202','111337','113921','2548872','2546388','2546946','2548552','2520459','2509772','2509966','2537761','2523732','111169','2534220','109113','108589','102371','2542712','2527887','2504979','2103997','2536072','2533431','2531736','2527678','2548985','121000','113356','2541042','100394','2516196','2530260','102760','2547783','2103287','2528413','107411','2508842','2536163','2529175','101112','2534067','107230','2539933','2542391','117736','2510530','2527524','2521104','2507883','112978','2526473','2535062','2540993','2541992','2530855','117838','2526183','2536809','2102418','2103304','2524253','2528991','112652','2545186','2546026','2544055','2537315','110748','2527747','116416','2532552','107400','2517372','100001249','2526033','118924','108179','113259','2520694','118604','2509825','2522599','2526426','2103118','2513404','2542738','2510077','2527415','109345','2513070','2535005','2527197','2510055','107627','2519679','2535703','2524831','2548534','2537713','2520960','2517414','2517180','2546334','2549806','2522841','2530185','2513205','2534905','2534303','114697','117423','2513653','106632','2532414','2540937','2100448','105316','2522815','120974','2512121','2529950','112124','115690','112123','2521694','2513035','121425','110277','117304','103253','2536338','2518047','102697','2519235','2102254','102538','2540400','110511','101177','2516110','2543884','2549528','2512823','108206','102407','2518848','2529240','2549740','104668','2539848','2510074','2549785','106283','2549783','2524864','2524871','2515250','113479','2534249','2507090','2527615','2516167','108657','111951','2526054','2515098','2513559','112194','2528340','2536814','2544842','2532269','2546036','2544291','2534616','2517811','2508224','2529218','2533018','119111','1100139','2544677','118189','2538787','2534586','2520951','104404','2533595','2543265','2516826','2530509','110816','2521275','2522398','112671','2549791','2543240','107697','2532153','2535594','2518991','2542560','118287','2544141','2547824','2540543','2524498','2526752','2527770','2528798','102461','2522190','2101600','108136','2532419','2515486','2523210','2528703','100737','2522288','2522330','2505601','109549','2549747','2509573','2521029','2521171','115278','2509156','2543663','2513057','2513135','2541999','121153','2512547','104679','2520880','105055','1300014','2521625','2534411','2103265','2531498','2549306','105526','2546341','100001486','2532203','1000094','2534380','2508960','2540079','2512498','2527726','2540207','117935','2540735','116495','2513209','2526581','2549092','2533126','115875','2510243','2521262','2528895','107116','2512893','2532735','112420','104207','2532824','100000389','2539377','2520793','2548049','2521444','2517939','101117','2523821','2505594','2521612','101086','2548945','2522204','2524009','2547733','2507507','114143','2548505','2536458','2505441','2526084','2541934','2534365','2542221','2517159','2549430','2544093','2536730','2520426','2536389','2547265','2527054');
	$requerido = array('OBLIGACIONES_CORRIENTES','OBLIGACIONES_VENCIDAS','DEUDA_PORTOAGUAS','VENCIMIENTO_FACTURA','fecha_emision_mes','fecha de facturacion');
	$q = 'SELECT 
	id_cuenta,cuenta,fecha_creacion
	FROM cuentas.cuenta c 
	WHERE c.id_proceso=157 AND c.cuenta IN(\''.implode('\',\'',$cuentas).'\')';
	$db = DB::getInstance();
	$q0 = $db->query($q);
	$qnm = $db->prepare('no_mapeada','SELECT * FROM cargas.carga_no_mapeada WHERE id_cuenta=$1 ORDER BY id_carga DESC');
	$result[]=array(
		'CUENTA',
		'VENCIMIENTO_FACTURA_corriente',
		'OBLIGACIONES_CORRIENTES',
		'OBLIGACIONES_VENCIDAS',
		'DEUDA_PORTOAGUAS',
		'VENCIMIENTO_FACTURA',
		'fecha_emision_mes',
		'fecha de asignacion'
	);
	
	while ($qa0 = $db->fetchOne($q0)){
		$aux=array();
		$q1 = $db->execute('no_mapeada',array($qa0['id_cuenta']));
		$datanm = array();
		while ($qa1 = $db->fetchOne($q1)){
			// if (in_array($qa1['campo'],$requerido)){
				$datanm[$qa1['id_carga']][$qa1['campo']]=$qa1['valor'];
			// }
		}
		$datanm = array_shift($datanm);
		$aux[] = $qa0['cuenta'];
		$aux[] = $datanm['fecha de facturacion'];
		$aux[] = $datanm['OBLIGACIONES_CORRIENTES'];
		$aux[] = $datanm['OBLIGACIONES_VENCIDAS'];
		$aux[] = $datanm['DEUDA_PORTOAGUAS'];
		$aux[] = $datanm['VENCIMIENTO_FACTURA'];
		$aux[] = $datanm['fecha_emision_mes'];
		$aux[] = $qa0['fecha_creacion'];

		$result[]=$aux;

	}


	$file = new Helpers_CSV_Writer();
	$file->setLines($result);
	header('Content-Disposition: attachment; filename="report.txt"');
	header('Content-Length: '.filesize($file->getFilePath()));
	readfile($file->getFilePath());
	die();



















//     $db = DB::getInstance();

//     // último proceso
//     $q = 'SELECT max(id_proceso) FROM campanas.proceso WHERE id_campana=18 AND status=\'1\'';
//     $q0 = $db->query($q);
//     $id_proceso=$db->fetchOne($q0)['max'];

//     // get gestiones
//     $q = 'SELECT
// 		c.cuenta,
//         c.valor_original,
//         CASE WHEN u.nombre_completo = \'GEOVANY RAMOS\' 
//             THEN \'GEOVANY RAMOS / MASIVOS\'
//             ELSE  u.nombre_completo
//         END AS nombre_completo,
//         g.* ,t.descripcion as tipificacion,
//         CASE WHEN tm.contactabilidad = \'1\' 
//             THEN \'CONTACTADO\'
//             ELSE  \'NO CONTACTADO\'
//         END AS contactabilidad,
//         tm.tipo_contactabilidad,
//         p.identificacion
//     FROM gestiones.gestion g
//         JOIN auth.auth_usuarios u ON g.user_name = u.usr_logname
//         JOIN cuentas.cuenta c ON c.id_cuenta = g.id_cuenta
//         JOIN personas.persona p ON p.id_persona = c.id_deudor
//         JOIN campanas.proceso pr ON pr.id_proceso = c.id_proceso
//         JOIN campanas.campana ca ON ca.id_campana = pr.id_campana
//         JOIN gestiones.tipificacion t ON t.id_tipificacion = g.id_tipificacion
//         JOIN gestiones.tipificacion_metadata tm ON tm.id_tipificacion = t.id_tipificacion
//     WHERE 
//         pr.id_proceso = '.$id_proceso.'	AND NOT EXISTS (SELECT * FROM gestiones.tipificacion WHERE id_tipificacion=t.id_tipificacion AND id_tipificacion IN(282,283,287,285,289))';

//     $q0 = $db->query($q);
//     $result = array();
// 	$resultados = array();
//     while ($qa0 = $db->fetchOne($q0)){

//         $aux = $qa0;
//         $aux['gestion_cobro'] = '';

//         // get carga no mapeada
//         $cnm = getCargaNoMapeada($qa0['id_cuenta']);
//         $cnm = array_shift($cnm);
//         if (floatval($cnm['RECAUDA_CONV_PAGO_TOT'])!=0){
// 			$resultados['convenio']++;
//             $aux['gestion_cobro'] = 'Convenio';
//         }else{
//             $fecha_gestion = $qa0['fecha_inicio'];
//             // get pagos
//             $ca = getActualizaciones($qa0['id_cuenta'],'ORDER BY ABS(diferencia) DESC, fecha_actualizacion DESC');
//             if (!empty($ca)){
//                 $pago = 0;
//                 foreach ($ca as $a){
//                     if ($a['tipo_actualizacion']=='PAGO' && strtotime($fecha_gestion)<=strtotime($a['fecha_actualizacion'])){
// 						$resultados['gestion_antes_pago']++;
//                         $pago = $pago + abs($a['diferencia']);
//                         break;
//                     }else{
// 						$resultados['pago_antes_de_gestion']++;
// 						break;
// 					}
//                 }
//                 if ($pago!=0){
//                     $porcentaje_pagado = ($pago*100)/$qa0['valor_original'];
//                     // si pagos supera el 40%
//                     if ($porcentaje_pagado>=40){
//                         $aux['gestion_cobro'] = '40%';
// 						$resultados['pago_40_porc']++;
//                         // print_arr($qa0['id_cuenta'].', Deuda: '.$qa0['valor_original'].' =====>Pago: '.$pago.'=====>'.$porcentaje_pagado);
//                     }else{
//                         $aux['gestion_cobro'] = 'PAGO MENOR 40%';
// 						$resultados['pago_sin_40']++;
//                     }
//                 }
//             }
//         }
//         $result[] = $aux;
//     }
//     print_arr($resultados);
//     die();































// $db = DB::getInstance();

// // último proceso
// $q = 'SELECT max(id_proceso) FROM campanas.proceso WHERE id_campana=18 AND status=\'1\'';
// $q0 = $db->query($q);
// $id_proceso=$db->fetchOne($q0)['max'];

// $q = 'SELECT
// 	c.id_cuenta,c.cuenta,ABS(ca.diferencia) as pago,ca.fecha_actualizacion,p.identificacion
// FROM cuentas.cuenta c
// 	JOIN personas.persona p ON(p.id_persona=c.id_deudor)
// 	JOIN cuentas.cuenta_actualizacion ca ON(ca.id_cuenta=c.id_cuenta)
// WHERE 
// 	c.id_proceso = '.$id_proceso.' AND 
// 	ca.tipo_actualizacion=\'PAGO\' AND 
// 	ca.fecha_actualizacion = (SELECT max(fecha_actualizacion) FROM cuentas.cuenta_actualizacion WHERE id_cuenta=ca.id_cuenta AND tipo_actualizacion=\'PAGO\')
// ORDER BY 
// 	ca.id_cuenta,ABS(ca.diferencia) DESC,ca.fecha_actualizacion DESC';

// $q0 = $db->query($q);
// $result = array();
// $cuenta_procesada = array();
// $total_pagos = 0;
// while ($qa0 = $db->fetchOne($q0)){
// 	// if ($qa0['id_cuenta']!=2192720) continue;
// 	if (!in_array($qa0['id_cuenta'],$cuenta_procesada)){
// 		$cuenta_procesada[] = $qa0['id_cuenta'];
// 		$result[] = $qa0;
// 		$total_pagos += $qa0['pago'];
// 	}
// }
// echo 'TOT PAGOS: '.$total_pagos.'<br>';
// echo 'NUM PAGOS: '.count($result).'<br>';
// print_arr($result);
// die();




	



// 	die();
// 	$mail = new Helpers_Mail();
// 	$to = array(
// 		'paul.cedeno@recappt.com',
// 		'paul.cedeno@bpoc3.com'
// 	);
// 	$mail->add_attachment('/tmp/xxx.txt');
// 	$mail->sendMail($to,'Testing the fuck mail','Content of Testing the fuck mail');

// 	die();



// $valor = '2021-05-12';
// print_r($valor);
// var_dump(preg_match('#^\d{4}\-(0?[1-9]|1[012])\-(0?[1-9]|[12][0-9]|3[01])$#',$valor,$matches));
// var_dump($matches);
// die();
// // if (preg_match('^\d{4}\-(0?[1-9]|1[012])\-(0?[1-9]|[12][0-9]|3[01])$',$valor)===0){
// // 	throw new Exception('El campo: '.$campo.' no tiene formato de fecha yyyy-mm-dd: '.$valor);
// // }



// function parseTelefonos($telefonos) {
// 	$ret=array();
// 	$aux=array();

// 	if(preg_match_all('#[^\d]#',$telefonos,$matches)) {
// 		$matches=array_unique($matches[0]);
// 		foreach($matches as $m) {
// 			foreach(explode($m,$telefonos) as $t) {
// 				$t=trim($t);
// 				if(preg_match('#^\d+$#',$t)) $aux[]=$t;
// 			}
// 		}
// 		$aux=array_unique($aux);
// 	}else{
// 		$aux[]=$telefonos;
// 	}
// 	foreach($aux as $a) {
// 		$a=ltrim($a,'0');
// 		if(strlen($a)==7) $a='4'.$a;
// 		if(!preg_match('#^9[1-9]\d{7}$#',$a) && !preg_match('#^[2-7]\d{7}$#',$a)) {
// 			continue;
// 		}
// 		if(preg_match('#(.)\1{5}#',$a)) continue;
// 		$ret[]='0'.$a;
			
// 	}
// 	return $ret;
// }

// print_r(parseTelefonos('0939941936;023521548'));





// die();

// 	require 'config.php';
// 	$db = DB::getInstance();

// 	$parametros = array(
// 		'lb'=>true,
// 		'bo'=>true,
// 		'lg'=>true,
// 	);
	
// 	$mineria = array();
// 	//get gestiones
// 	foreach(getGestionesByCampaña(15) as $identificacion => $r){
// 		//if ($identificacion!='0104178769') continue;
// 		// echo 'identificacion';
// 		// print_arr($identificacion);
// 		// echo 'telefonos_gestionados';
// 		// print_arr($r['telefono_gestion']);
// 		// echo 'telefonos_base';
// 		// print_arr($r['telefonos_base']);
// 		$aux = array();
// 		$aux[]=$identificacion;

// 		//get numeros de repo
// 		$tels_repo = _getTelefonosRepositorio($identificacion);
// 		// echo 'telefonos_repositorio';
// 		// print_arr($tels_repo);
// 		// $keys = array_column($tels_repo, 'clasificacion_telefono');
// 		// array_multisort($keys, SORT_ASC, $tels_repo);

// 		//se agregan LB (LISTAS BLANCAS)
// 		if ($parametros['lb']){
// 			foreach($tels_repo as $rr){

// 				// se excluye si ya fue agregado
// 				if (in_array($rr['numero_telefono'],$aux)) continue;
// 				// se excluye el telefono de gestión que es no contactable
// 				if (in_array($rr['numero_telefono'],$r['telefono_gestion'])) continue;

// 				if ($rr['clasificacion_telefono']=='lista_blanca'){
// 					$aux[]=$rr['numero_telefono'];
// 				}
// 			}
// 		}

// 		//se agregan BO (BASE ORIGINAL)
// 		if ($parametros['bo']){
// 			foreach($r['telefonos_base'] as $tel){

// 				// se excluye si ya fue agregado
// 				if (in_array($tel,$aux)) continue;
// 				// se excluye el telefono de gestión que es no contactable
// 				if (in_array($tel,$r['telefono_gestion'])) continue;

// 				$aux[]=$tel;
// 			}
// 		}

// 		//se agregan LG (LISTAS GRIS)
// 		if ($parametros['lg']){
// 			foreach($tels_repo as $rr){

// 				// se excluye si ya fue agregado
// 				if (in_array($rr['numero_telefono'],$aux)) continue;
// 				// se excluye el telefono de gestión que es no contactable
// 				if (in_array($rr['numero_telefono'],$r['telefono_gestion'])) continue;

// 				if ($rr['clasificacion_telefono']=='lista_gris'){
// 					$aux[]=$rr['numero_telefono'];
// 				}
// 			}
// 		}

// 		$mineria[]=$aux;
// 	}
// 	echo 'minería';
// 	print_arr($mineria);
// 	die();





// 	function getGestionesByCampaña($id_campana){
// 		global $db;
// 		$q = 'SELECT 
// 			p.id_persona,p.identificacion,g.fecha_inicio,g.tel_number,t.descripcion,pr.descripcion as proceso, te.telefono,te.origen
// 		FROM gestiones.gestion g
// 			JOIN gestiones.tipificacion t USING(id_tipificacion)
// 			JOIN gestiones.tipificacion_metadata tm ON(tm.id_tipificacion=t.id_tipificacion)
// 			JOIN cuentas.cuenta c USING(id_cuenta)
// 			JOIN personas.persona p ON (p.id_persona=c.id_deudor)
// 			LEFT JOIN medios_contacto.telefono te ON(te.id_persona=p.id_persona)
// 			JOIN campanas.proceso pr ON(pr.id_proceso=c.id_proceso)
// 		WHERE
// 			pr.id_campana='.$id_campana.' AND g.fecha_inicio BETWEEN \'2021-11-08\' AND \'2021-11-09\' AND tm.contactabilidad=\'0\' AND te.origen=\'BASE\' -- AND p.identificacion=\'0101856813\' LIMIT 15';
// 		$gestiones = array();
// 		foreach ($db->query($q)as $r){
// 			if (!in_array($r['tel_number'],$gestiones[$r['identificacion']]['telefono_gestion'])){
// 				$gestiones[$r['identificacion']]['telefono_gestion'][]=$r['tel_number'];
// 			}
// 			if ($r['tel_number']==$r['telefono']) continue;
// 			if (!in_array($r['telefono'],$gestiones[$r['identificacion']]['telefonos_base'])){
// 				$gestiones[$r['identificacion']]['telefonos_base'][]=$r['telefono'];
// 			}
// 		}
// 		return $gestiones;
// 	}